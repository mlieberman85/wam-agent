(function($){var a={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",prePopulate:null,processPrePopulate:!1,idPrefix:"token-input-",resultsFormatter:function(a){return"<li>"+a[this.propertyToSearch]+"</li>"},tokenFormatter:function(a){return"<li><p>"+a[this.propertyToSearch]+"</p></li>"},onResult:null,onAdd:null,onDelete:null,onReady:null},b={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},c={BEFORE:0,AFTER:1,END:2},d={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},e={init:function(b,c){var d=$.extend({},a,c||{});return this.each(function(){$(this).data("tokenInputObject",new $.TokenList(this,b,d))})},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(a){return this.data("tokenInputObject").add(a),this},remove:function(a){return this.data("tokenInputObject").remove(a),this},get:function(){return this.data("tokenInputObject").getTokens()}};$.fn.tokenInput=function(a){return e[a]?e[a].apply(this,Array.prototype.slice.call(arguments,1)):e.init.apply(this,arguments)},$.TokenList=function(a,e,f){function w(){if(f.tokenLimit!==null&&i>=f.tokenLimit){m.hide(),G();return}}function x(){if(l===(l=m.val()))return;var a=l.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");u.html(a),m.width(u.width()+30)}function y(a){return a>=48&&a<=90||a>=96&&a<=111||a>=186&&a<=192||a>=219&&a<=222}function z(a){var b=f.tokenFormatter(a);b=$(b).addClass(f.classes.token).insertBefore(s),$("<span>"+f.deleteText+"</span>").addClass(f.classes.tokenDelete).appendTo(b).click(function(){return E($(this).parent()),n.change(),!1});var c={id:a.id};return c[f.propertyToSearch]=a[f.propertyToSearch],$.data(b.get(0),"tokeninput",a),h=h.slice(0,p).concat([c]).concat(h.slice(p)),p++,F(h,n),i+=1,f.tokenLimit!==null&&i>=f.tokenLimit&&(m.hide(),G()),b}function A(a){var b=f.onAdd;if(i>0&&f.preventDuplicates){var c=null;r.children().each(function(){var b=$(this),d=$.data(b.get(0),"tokeninput");if(d&&d.id===a.id)return c=b,!1});if(c){B(c),s.insertAfter(c),m.focus();return}}if(f.tokenLimit==null||i<f.tokenLimit)z(a),w();m.val(""),G(),$.isFunction(b)&&b.call(n,a)}function B(a){a.addClass(f.classes.selectedToken),o=a.get(0),m.val(""),G()}function C(a,b){a.removeClass(f.classes.selectedToken),o=null,b===c.BEFORE?(s.insertBefore(a),p--):b===c.AFTER?(s.insertAfter(a),p++):(s.appendTo(r),p=i),m.focus()}function D(a){var b=o;o&&C($(o),c.END),b===a.get(0)?C(a,c.END):B(a)}function E(a){var b=$.data(a.get(0),"tokeninput"),c=f.onDelete,d=a.prevAll().length;d>p&&d--,a.remove(),o=null,m.focus(),h=h.slice(0,d).concat(h.slice(d+1)),d<p&&p--,F(h,n),i-=1,f.tokenLimit!==null&&m.show().val("").focus(),$.isFunction(c)&&c.call(n,b)}function F(a,b){var c=$.map(a,function(a){return a[f.tokenValue]});b.val(c.join(f.tokenDelimiter))}function G(){t.hide().empty(),q=null}function H(){t.css({position:"absolute",top:$(r).offset().top+$(r).outerHeight(),left:$(r).offset().left,zindex:999}).show()}function I(){f.searchingText&&(t.html("<p>"+f.searchingText+"</p>"),H())}function J(){f.hintText&&(t.html("<p>"+f.hintText+"</p>"),H())}function K(a,b){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function L(a,b,c){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","g"),K(b,c))}function M(a,b){if(b&&b.length){t.empty();var c=$("<ul>").appendTo(t).mouseover(function(a){N($(a.target).closest("li"))}).mousedown(function(a){return A($(a.target).closest("li").data("tokeninput")),n.change(),!1}).hide();$.each(b,function(b,d){var e=f.resultsFormatter(d);e=L(e,d[f.propertyToSearch],a),e=$(e).appendTo(c),b%2?e.addClass(f.classes.dropdownItem):e.addClass(f.classes.dropdownItem2),b===0&&N(e),$.data(e.get(0),"tokeninput",d)}),H(),f.animateDropdown?c.slideDown("fast"):c.show()}else f.noResultsText&&(t.html("<p>"+f.noResultsText+"</p>"),H())}function N(a){a&&(q&&O($(q)),a.addClass(f.classes.selectedDropdownItem),q=a.get(0))}function O(a){a.removeClass(f.classes.selectedDropdownItem),q=null}function P(){var a=m.val().toLowerCase();a&&a.length&&(o&&C($(o),c.AFTER),a.length>=f.minChars?(I(),clearTimeout(k),k=setTimeout(function(){Q(a)},f.searchDelay)):G())}function Q(a){var b=a+R(),c=j.get(b);if(c)M(a,c);else if(f.url){var d=R(),e={};e.data={};if(d.indexOf("?")>-1){var g=d.split("?");e.url=g[0];var h=g[1].split("&");$.each(h,function(a,b){var c=b.split("=");e.data[c[0]]=c[1]})}else e.url=d;e.data[f.queryParam]=a,e.type=f.method,e.dataType=f.contentType,f.crossDomain&&(e.dataType="jsonp"),e.success=function(c){$.isFunction(f.onResult)&&(c=f.onResult.call(n,c)),j.add(b,f.jsonContainer?c[f.jsonContainer]:c),m.val().toLowerCase()===a&&M(a,f.jsonContainer?c[f.jsonContainer]:c)},$.ajax(e)}else if(f.local_data){var i=$.grep(f.local_data,function(b){return b[f.propertyToSearch].toLowerCase().indexOf(a.toLowerCase())>-1});$.isFunction(f.onResult)&&(i=f.onResult.call(n,i)),j.add(b,i),M(a,i)}}function R(){var a=f.url;return typeof f.url=="function"&&(a=f.url.call()),a}if($.type(e)==="string"||$.type(e)==="function"){f.url=e;var g=R();f.crossDomain===undefined&&(g.indexOf("://")===-1?f.crossDomain=!1:f.crossDomain=location.href.split(/\/+/g)[1]!==g.split(/\/+/g)[1])}else typeof e=="object"&&(f.local_data=e);f.classes?f.classes=$.extend({},b,f.classes):f.theme?(f.classes={},$.each(b,function(a,b){f.classes[a]=b+"-"+f.theme})):f.classes=b;var h=[],i=0,j=new $.TokenList.Cache,k,l,m=$('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",f.idPrefix+a.id).focus(function(){(f.tokenLimit===null||f.tokenLimit!==i)&&J()}).blur(function(){G(),$(this).val("")}).bind("keyup keydown blur update",x).keydown(function(a){var b,e;switch(a.keyCode){case d.LEFT:case d.RIGHT:case d.UP:case d.DOWN:if(!!$(this).val()){var f=null;return a.keyCode===d.DOWN||a.keyCode===d.RIGHT?f=$(q).next():f=$(q).prev(),f.length&&N(f),!1}b=s.prev(),e=s.next(),b.length&&b.get(0)===o||e.length&&e.get(0)===o?a.keyCode===d.LEFT||a.keyCode===d.UP?C($(o),c.BEFORE):C($(o),c.AFTER):a.keyCode!==d.LEFT&&a.keyCode!==d.UP||!b.length?(a.keyCode===d.RIGHT||a.keyCode===d.DOWN)&&e.length&&B($(e.get(0))):B($(b.get(0)));break;case d.BACKSPACE:b=s.prev();if(!$(this).val().length)return o?(E($(o)),n.change()):b.length&&B($(b.get(0))),!1;$(this).val().length===1?G():setTimeout(function(){P()},5);break;case d.TAB:case d.ENTER:case d.NUMPAD_ENTER:case d.COMMA:if(q)return A($(q).data("tokeninput")),n.change(),!1;break;case d.ESCAPE:return G(),!0;default:String.fromCharCode(a.which)&&setTimeout(function(){P()},5)}}),n=$(a).hide().val("").focus(function(){m.focus()}).blur(function(){m.blur()}),o=null,p=0,q=null,r=$("<ul />").addClass(f.classes.tokenList).click(function(a){var b=$(a.target).closest("li");b&&b.get(0)&&$.data(b.get(0),"tokeninput")?D(b):(o&&C($(o),c.END),m.focus())}).mouseover(function(a){var b=$(a.target).closest("li");b&&o!==this&&b.addClass(f.classes.highlightedToken)}).mouseout(function(a){var b=$(a.target).closest("li");b&&o!==this&&b.removeClass(f.classes.highlightedToken)}).insertBefore(n),s=$("<li />").addClass(f.classes.inputToken).appendTo(r).append(m),t=$("<div>").addClass(f.classes.dropdown).appendTo("body").hide(),u=$("<tester/>").insertAfter(m).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:m.css("fontSize"),fontFamily:m.css("fontFamily"),fontWeight:m.css("fontWeight"),letterSpacing:m.css("letterSpacing"),whiteSpace:"nowrap"});n.val("");var v=f.prePopulate||n.data("pre");f.processPrePopulate&&$.isFunction(f.onResult)&&(v=f.onResult.call(n,v)),v&&v.length&&$.each(v,function(a,b){z(b),w()}),$.isFunction(f.onReady)&&f.onReady.call(),this.clear=function(){r.children("li").each(function(){$(this).children("input").length===0&&E($(this))})},this.add=function(a){A(a)},this.remove=function(a){r.children("li").each(function(){if($(this).children("input").length===0){var b=$(this).data("tokeninput"),c=!0;for(var d in a)if(a[d]!==b[d]){c=!1;break}c&&E($(this))}})},this.getTokens=function(){return h}},$.TokenList.Cache=function(a){var b=$.extend({max_size:500},a),c={},d=0,e=function(){c={},d=0};this.add=function(a,f){d>b.max_size&&e(),c[a]||(d+=1),c[a]=f},this.get=function(a){return c[a]}}})(jQuery);